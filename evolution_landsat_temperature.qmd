---
title: "Dynamiques des températures LANDSAT sur la période [2016-2024] sur quelques favelas"
format: 
  html:
    fig-width: 25
    fig-height: 25
---

```{r warning=FALSE, message=FALSE}
#| echo: false

# chargement des packages nécessaires
base::library(tidyverse) # tidy data manipulation in R
base::library(raster)    # raster data manipulation
base::library(sf)        # vector data manipulation

# chargement du fichier vectoriel {shp} de la région d'intéret (en UTM)
favelas<- sf::read_sf("../../favelas/favelas.shp")

# reprojection de la couche en WGS 84 / UTM zone 23N
favelas<- sf::st_transform(favelas, 32623)

# sélection des favelas pour lesquelles les statistiques seront calculées
selected_favelas<- dplyr::filter(
  favelas, nome %in% c("Rocinha", "Vila Joaniza", "Bairro da Pedreira", "Fazenda Coqueiro", "Nova Cidade")
)
# fonction de calcul des statistiues sur les températures LANDSAT
# définition d'une fonction pour découper les bandes en fonction de la couche 
# vectorielle de la région d'intéret (ROI)
temperature_stats<- function(bands_folder_path, favelas_db){
  #-----------------------------------------------------------------------|
  #* PARAMETERS
  #* favelas_db : shapefile contenant les noms des favelas
  #* bands_folder_path : dossier contenant les bandes spectrales à découper
  #-----------------------------------------------------------------------|
  
  if(stringr::str_detect(bands_folder_path, pattern="LC*")){
    # repertoire de stockage des images découpés
    # Replace default system slash, assume spn was generated by system.
    ls_srt_folders_file <- base::strsplit(bands_folder_path, .Platform$file.sep)[[1]]
    # extraire le nom du dossier de l'image
    image_folder_name<- utils::tail(ls_srt_folders_file, n=1)
    
    # Vérification/Création du dossier global de stockage des résultats du  décopage
    # if(!dir.exists("./landsat/Images-Selectionnees/IMAGES-DECOUPEES"))
    # {
    #   dir.create("./landsat/Images-Selectionnees/IMAGES-DECOUPEES")
    # }
    
    # Création du dossier global de stockage de chaque image
    # if(!base::dir.exists(
    #   base::paste0("./landsat/Images-Selectionnees/IMAGES-DECOUPEES/", image_folder_name)
    # ))
    # {
    #   base::dir.create(
    #     base::paste0("./landsat/Images-Selectionnees/IMAGES-DECOUPEES/", image_folder_name)
    #   )
    # }
    
    # chemins absolus de le la bande 10 (température de surface)
    b10_tif<- base::paste0(
      bands_folder_path, "/", base::list.files(bands_folder_path, pattern="B10.TIF$")
    )

    # date de l'image
    img_date<- base::substr(image_folder_name, 18, 25)
    
    # chargement du fichier tif
    B10<- raster::raster(b10_tif)

    # initialiser un dataframe résultat
    init_df<- tibble::tibble(
      Date = base::character(),
      Favelas =  base::character(),
      Moyenne = base::double(),
      Mediane = base::double(),
      Ecart.Type = base::double(),
      Min. = base::double(),
      Max. = base::double(),
      NB_pixel = base::double()
    )
    
    # itération sur chaque favelas pour calculer les températures moyennes
    for (fav in favelas_db$nome) # pour chaque fichier tif du dossier
    {
      # sélection de la favela dans la table des favelas
      favelas_in_process<- dplyr::filter(favelas_db, nome==fav)

      # découper l'image  en utilisant l'étendue du vecteur de zone d'intérêt
      cropped_rast<- raster::crop(B10, favelas_in_process)
      
      # masker l'image découper
      masked_rast <- raster::mask(cropped_rast, favelas_in_process)
      
      # calculer les statistiques
      fav_stats<-  data.frame(
        Date = img_date,
        Favelas = fav,
        Moyenne = base::mean(masked_rast[], na.rm=TRUE),
        Mediane = stats::median(masked_rast[], na.rm=TRUE),
        Ecart.Type = stats::sd(masked_rast[], na.rm=TRUE),
        Min. = base::min(masked_rast[], na.rm=TRUE),
        Max. = base::max(masked_rast[], na.rm=TRUE),
        NB_pixel = base::length(stats::na.omit(masked_rast[]))
      )
      
      # ajout à la tabl initialisé
      init_df<- dplyr::bind_rows(init_df, fav_stats)
    }
    
    # return
    base::return(init_df)
  }
}

# créer une liste de tous les sous-dossiers du repertoire global landsat
images_folders_list<- base::list.dirs(
  base::paste0("../../landsat/Images-Selectionnees/IMAGES-DECOUPEES"), recursive=F
)[-1]

#--------------------------------------------------------------|
# calculer les stats sur toutes les dates
# initialiser un data.frame pour contenir les statistiques
statistics_results<- tibble::tibble(
  Date = base::character(),
  Favelas =  base::character(),
  Moyenne = base::double(),
  Mediane = base::double(),
  Ecart.Type = base::double(),
  Min. = base::double(),
  Max. = base::double(),
  NB_pixel = base::double()
)

# loop
for(fold in images_folders_list)
{
  statistics_results <- dplyr::bind_rows(
    statistics_results, temperature_stats(fold, selected_favelas)
  )
}

# formatter la date
statistics_results<- dplyr::mutate(
  statistics_results, Date = lubridate::ymd(Date)
)

# courbe d'évolution des températures
temperature_line_plot<- statistics_results |>
  group_by(Favelas) |>
  ggplot() +
  geom_line(aes(x=Date, y=Moyenne, color=Favelas), linewidth=.5) +
  # améliorer l'axe des abscisses
  scale_x_date(date_breaks = "1 year", date_labels="%Y", expand=c(0.01, 0.01))+
  scale_y_continuous(expand=c(0.01, 0.01), trans="log",
                     breaks=seq(min(statistics_results$Moyenne),
                                max(statistics_results$Moyenne),
                                length.out=10),
                     labels=function(x) round(x))+
  # la légende
  ggplot2::guides(
    color = ggplot2::guide_legend(
      override.aes=list(linewidth=1.5, size = 3)
    )
  ) +
  # défnir les couleurs du graphiques
  scale_color_manual(values=c(
    "#ff007f", "green", "cyan", "#6BAED6", "#FEB24C"
  )) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill="white", color="gray", linewidth=1),
    axis.title=element_blank(),    # omettre l'axe des ordonnées
    axis.text=element_text(size=12, hjust=.5), # étiquette de l'axe des abscisses
    plot.title=element_blank(), # masquer le titre du graphique
    plot.background=element_rect(fill="white", color=NA), # couleur du fond du plan
    plot.margin=margin(rep(.3, 4), unit="cm"),
    # panel.background=element_rect(fill="white", color="gray", linewidth=1),
    panel.spacing.x=unit(3, "cm"),
    panel.spacing.y=unit(10, "cm"),
    # panel.grid=element_line(color="gray", linewidth=.35),
    legend.position=c(.94, .08),
    legend.title=element_blank(),
    legend.text=element_text(size=12, margin=margin(l=-.02, unit="cm")),
    legend.key=element_blank(),
    legend.background=element_blank()
  )

# convertir le grahique en un graph interactive avec plotly
plotly::ggplotly(temperature_line_plot)
```

::: {.callout-note appearance="simple" collapse="true"}

# Voir les données

```{r warning=FALSE, message=FALSE}
#| label: tbl-planet-measures
#| tbl-cap: Statistiques des températures LANDSAT dans quelques Favelas
#| echo: false

kableExtra::kable(statistics_results) |>
kableExtra::kable_styling(font_size = 16)
```

:::